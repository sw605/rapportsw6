%meta text
This subsection contains an overview of the implementation of the API calls utilized to communicate with \gls{astep}.
Both the api calls in the app and on the RS server will be presented.

 \subsubsection{Application}
In the design phases \ref{sec:aSTEPCommunication.tex} it was decided what API calls should be implemented in the app.
A specified list of calls only to be performed on the app can be seen in the table below.

\begin{table}[h]
	\centering
	\scriptsize
	\begin{tabular}{l l l}
		Path & Method & Description\\\midrule
		/locations/outdoor/\{username\}/routes & POST & Send a route to the \gls{astep} server\\
		/users & POST & Create a new user\\
		/users/\{username\}/token & GET & Get the current valid token for a user\\
		/users & POST & Invalidate old token and get new\\
		/users/\{username\}/token & POST & Invalidates previous token for a user\\
	\end{tabular}
	\caption{Caption}
	\label{tab:asteprequests}
\end{table} 

The API calls are implemented using a \texttt{HttpURLConnection} class, which is a \texttt{URLConnection} class for HTTP specific data transfer over the web.
\texttt{HttpURLConnection} may be used to send and receive streaming data whose length is not known in advance.
This is needed as every API call varies in size.
E.g., the API call to post a route will be the one that varies the most in size as routes differ in size, based on the number of locations and their accuracy.


Using an object oriented structure, each API call is implemented to overwrite a \texttt{helperClass} which will handle the inputs, such as username, password, token, and routes.
The inputs are then transformed to a part of a URL which would fit each of the relevant API calls.
The \texttt{helperClass} is then parsed to the \texttt{HttpURLConnection} which will use a string builder to create the final URL from the API base URL, \texttt{http://astep.cs.aau.dk:80/api/}.
Lastly, the \texttt{HttpURLConnection} is trying to perform the API call from where response codes are handled.

It should be noted that passwords are not in the URL part of the API call, as these will be logged on the \gls{astep} server. 
This would be a major security issue.
Instead password and tokens are parsed as part of the body or header, which is used by REST. 
This will hide the content from the URL and instead be transfered in an \texttt{OutputStream} encoded in raw bytes. 
Two examples of API calls can be seen in \ref{apitable}.

\begin{table}[]
\scriptsize
\centering
\label{apitable}
\begin{tabular}{|l|l|lll}
\cline{1-2}
POST new user &                                                                                                                                                                                                                                                                                             &  &  &  \\ \cline{1-2}
URL:          & http://astep.cs.aau.dk:80/api/users?username=USERNAME                                                                                                                                                                                                                                       &  &  &  \\ \cline{1-2}
CURL:         & \begin{tabular}[c]{@{}l@{}}curl -X POST -\-header 'Content-Type: application/json' -\-header 'Accept: application/json'\\  -d 'PASSWORD' 'http://astep.cs.aau.dk:80/api/users?username=USERNAME'\end{tabular}                                                                               &  &  &  \\ \cline{1-2}
POST route    &                                                                                                                                                                                                                                                                                             &  &  &  \\ \cline{1-2}
URL:          & \begin{tabular}[c]{@{}l@{}}http://astep.cs.aau.dk:80/api/locations/outdoor/outdoor/routes?authorization=TOKEN\\ \&route=longitude,latitude,precision,timestamp;\&distance\_weight\&time\_weight\\ \&largest\_acceptable\_detour\_length=146\&acceptable\'httptime\_difference=32h\end{tabular} &  &  &  \\ \cline{1-2}
CURL:         & \begin{tabular}[c]{@{}l@{}}curl -X POST -\-header 'Content-Type: application/json'\\  -\-header 'Accept: application/json' 'URL from above'\end{tabular}                                                                                                                                    &  &  &  \\ \cline{1-2}
\end{tabular}
\caption{Create user and send route to \gls{astep} api calls}
\end{table}


As seen in 'POST new user', the username is parsed in the URL while the password is included in a header.
On the other hand, the 'POST route to \gls{astep}' is only parsed in the URL as there is no information that needs to be hidden.
The post route example is simplified to reduce size and make it better explainable.
Longitude, latitude, and precision are all doubles.
timestamp is of the ISO format with year, month, day, hour, minute, second.  
The rest of the parameters is integers used to control the algorithm as explained in \ref{sec:routematchingalgorith}. 




Every decision made regarding parsing data to the \gls{astep} server is decided by the individual \gls{astep} API groups.

\subsubsection{RideShare Server}
On the RS server a faster implementation were done.
The RS server requires only two API calls one for getting matched routes from \gls{astep} and one for checking if a user is a valid \gls{astep} user.
Both API calls is implemented as their own \texttt{HttpURLConnection}.
The validate user check is performed when a user create a user in the app. First a user is created at \gls{astep} then a request to the RideShare server is issued, where a check is performed to ensure the user correctly registered in \gls{astep}.
The check is done by sending the token received from \gls{astep} to the RideShare server and then checked up against \gls{astep} again.
If the user is valid the additional information provided when registering will be stored on our RideShare server for later retrieval. 

The route match api call is right now called when the server is requested to do so by the developers. \todo{Jeg er ikke sikker p√• det her er korrekt}
The api call will use the token provided to fetch matched to the user related to the token. 
\gls{astep} will then return every match for that user, with a score, the matched routes and the name of who the matches is with.
This information is then send back to the application to be displayed.